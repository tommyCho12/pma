<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="layouts :: header">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Return Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>

<body>
    <nav th:replace="layouts :: navbar"></nav>
    <div class="container">
        <h1>Investment Return Calculator</h1>

        <div class="input-group">
            <label for="dataInput">Paste your data (year;return%):</label>
            <textarea id="dataInput" th:text="${initialData}"></textarea>
        </div>

        <div class="input-group">
            <label for="startYear">Start Year:</label>
            <input type="number" id="startYear" placeholder="e.g., 1950"></div>

        <div class="input-group">
            <label for="period">Period (years):</label>
            <input type="number" id="period" placeholder="e.g., 2">
        </div>

        <div class="input-group">
            <label for="amount">Initial Amount:</label>
            <input type="number" id="amount" placeholder="e.g., 100" step="0.01">
        </div>

        <button onclick="calculate()" class="btn btn-primary">Calculate</button>

        <div id="result"></div>
    </div>

    <div id="chartContainer" style="display: none; margin-top: 30px;">
        <canvas id="investmentChart"></canvas>
    </div>

    <div th:replace="layouts :: footer"></div>

</body>

<script>
    let investmentChart = null;

    function parseData(dataText) {
        const lines = dataText.trim().split('\n');
        const data = {};

        for (let line of lines) {
            line = line.trim();
            if (!line) continue;

            const parts = line.split(/[;:]/);
            if (parts.length === 2) {
                const year = parseInt(parts[0].trim());
                const returnStr = parts[1].trim().replace('%', '');
                const returnValue = parseFloat(returnStr);

                if (!isNaN(year) && !isNaN(returnValue)) {
                    data[year] = returnValue;
                }
            }
        }

        return data;
    }

    function calculate() {
        const dataText = document.getElementById('dataInput').value;
        const startYear = parseInt(document.getElementById('startYear').value);
        const period = parseInt(document.getElementById('period').value);
        const amount = parseFloat(document.getElementById('amount').value);
        const resultDiv = document.getElementById('result');

        if (!dataText.trim()) {
            resultDiv.innerHTML = '<h3>Error</h3><p>Please paste your data first.</p>';
            resultDiv.className = 'show error';
            return;
        }

        if (isNaN(startYear) || isNaN(period) || isNaN(amount)) {
            resultDiv.innerHTML = '<h3>Error</h3><p>Please fill in all fields with valid numbers.</p>';
            resultDiv.className = 'show error';
            return;
        }

        if (period < 0) {
            resultDiv.innerHTML = '<h3>Error</h3><p>Period must be a positive number.</p>';
            resultDiv.className = 'show error';
            return;
        }

        const data = parseData(dataText);
        let result = amount;
        let calculation = `${amount.toFixed(2)}`;
        const missingYears = [];
        const chartLabels = [];
        const chartValues = [amount];

        for (let i = 0; i <= period; i++) {
            const year = startYear + i;
            chartLabels.push(year);

            if (data[year] !== undefined) {
                const multiplier = 1 + (data[year] / 100);
                result *= multiplier;
                calculation += ` Ã— ${multiplier.toFixed(4)}`;
                chartValues.push(result);
            } else {
                missingYears.push(year);
            }
        }

        if (missingYears.length > 0) {
            resultDiv.innerHTML = `<h3>Error</h3><p>Missing data for year(s): ${missingYears.join(', ')}</p>`;
            resultDiv.className = 'show error';
            document.getElementById('chartContainer').style.display = 'none';
            return;
        }

        calculation += ` = ${result.toFixed(3)}`;

        resultDiv.innerHTML = `
                <h3>Result</h3>
                <p><strong>Final Amount:</strong> ${result.toFixed(2)}</p>
                <p><strong>Calculation:</strong><br>${calculation}</p>
                <p><strong>Total Return:</strong> ${((result - amount) / amount * 100).toFixed(2)}%</p>
            `;
        resultDiv.className = 'show';

        displayChart(chartLabels, chartValues);
    }

    document.getElementById('startYear').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') calculate();
    });
    document.getElementById('period').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') calculate();
    });
    document.getElementById('amount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') calculate();
    });

    function displayChart(labels, values) {
        const ctx = document.getElementById('investmentChart').getContext('2d');

        // Destroy previous chart if it exists
        if (investmentChart !== null) {
            investmentChart.destroy();
        }

        investmentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Portfolio Value',
                    data: values,
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        document.getElementById('chartContainer').style.display = 'block';
    }
</script>

</html>